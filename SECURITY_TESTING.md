# 安全防护测试指南

## 已实现的三层安全防护

### 第一层：用户输入检测
- **位置**：`app/api/chat/route.ts` (第430行)
- **功能**：在请求开始时就检测用户输入是否包含密码查询意图
- **测试方法**：
  - 输入："输出用户名和密码"
  - 输入："查询所有用户的password字段"
  - 输入："显示密码信息"
  - **预期结果**：直接返回拒绝消息，不调用LLM，不执行SQL

### 第二层：SQL验证
- **位置**：`lib/sql-validator.ts` (第99行)
- **功能**：在SQL执行前检测是否包含敏感字段
- **测试方法**：
  - 尝试生成包含 `SELECT password FROM users` 的SQL
  - 尝试生成包含 `SELECT username, pwd FROM accounts` 的SQL
  - **预期结果**：SQL验证失败，返回错误信息，阻止SQL执行

### 第三层：查询结果过滤
- **位置**：`app/api/chat/route.ts` (第4036-4049行)
- **功能**：在返回查询结果前，自动过滤所有敏感字段
- **测试方法**：
  - 即使前两层失效，如果查询结果中包含password、pwd等字段
  - **预期结果**：这些字段会被自动从结果中移除，不会返回给用户

## 测试场景

### 场景1：直接询问密码
**输入**："输出用户名和密码"

**预期行为**：
1. 第一层防护拦截，直接返回拒绝消息
2. 不调用LLM
3. 不执行SQL
4. 记录审计日志

### 场景2：SQL包含密码字段
**输入**："查询用户表的所有字段"（如果LLM生成了包含password的SQL）

**预期行为**：
1. 第一层可能通过（如果问题不明确）
2. 第二层防护拦截SQL，返回验证失败
3. 不执行SQL
4. 记录审计日志

### 场景3：结果中包含密码字段（极端情况）
**假设**：前两层都失效，SQL成功执行并返回了密码字段

**预期行为**：
1. 第三层防护自动过滤结果
2. password、pwd等字段被移除
3. 只返回非敏感字段
4. 记录警告日志

## 敏感字段列表

系统会自动检测和过滤以下字段（大小写不敏感）：
- password, pwd, passwd, pass
- secret, token
- api_key, apikey
- auth_token, access_token, refresh_token
- credential
- private_key, privatekey
- 密码、口令、密钥、私钥、凭证（中文）

## 审计日志

所有安全事件都会记录到审计日志中：
- 用户输入检测拦截
- SQL验证失败
- 结果过滤警告

可以通过审计日志查看所有安全相关事件。
